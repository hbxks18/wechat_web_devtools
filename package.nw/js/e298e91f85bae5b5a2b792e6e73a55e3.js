'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('mkdir-p'),d=require('./72653d4b93cdd7443296229431a7aa9a.js'),e=require('./common/locales/index.js'),f=require('./5321b622f9bab971490e99e09b2389a9.js'),g=require('./f171257bbcaef547a3cf27266ccb0db2.js'),h=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),i=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),j=require('./a8c87029da0fa06e986298d447ab0fe2.js'),k=require('./3e74bc0c6a5fa450386148788cc0cf44.js'),l=require('./db2217eb4cff896bdcbc50abe005058f.js'),m=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),n=require('./874074ba4ecebc4e49310ccc42243ff5.js'),o=require('./19404cae4023ed740f4fe4bce92ebf66.js'),p=require('./3bfffbe88b3d923921f851c0697974fe.js'),q=require('./3892cb9d0783075a973c350c41401370.js'),r=require('./da7c31daaf542cf1796023d8e344b98a.js'),s=require('./15ba1827c7f6564a45df6bd44da3a977.js'),t=require('./664c85134de31b9a04ff1f03a1492daf.js'),u=t.get(),v=()=>{},{TCB_STAGE_PREPARE:w,TCB_STAGE_GET_FUNCTION_INFO:x,TCB_STAGE_CHECK_TRIGGERS:y,TCB_STAGE_UPDATE_FUNCTION_CONFIG:z,TCB_STAGE_COMPRESS_FUNCTION_CODE:A,TCB_STAGE_WILL_UPLOAD_FUNCTION:B,TCB_STAGE_UPLOAD_FUNCTION:C,TCB_STAGE_UPLOAD_FUNCTION_TRIGGERS:D,TCB_STAGE_WAIT_FUNCTION_UPDATE:E,TCB_STAGE_WAIT_FUNCTION_UPDATE_AND_NPM:F,TCB_STAGE_UPLOAD_DONE:G}=e.config,H=(d,e)=>{for(let f,g=0,h=e.length;g<h;g++)f=b.join(d,e[g].FunctionName),a.existsSync(f)||c.sync(f)},I=async(a)=>{const b=p.getCurrentTcbInfo();let c=b.currentEnv&&b.currentEnv.namespace;if(c)return c;let d,e=(await J()(a))||[];if(0>=e.length)d=l.get(m.WINDOW_REGISTRY.CLOUD_CONSOLE),d?d.focus():a({type:h.WINDOW_SET_CLOUD,data:{console:{show:!0}}});else{if(1==e.length)return a(K(0)),c=e[0].namespace,c;d=l.get(m.WINDOW_REGISTRY.CLOUD_SCF_ACTION),d?d.focus():a({type:h.WINDOW_SET_CLOUD,data:{fnaction:{show:!0},cloudfunctionRoot:{show:!0}}})}},J=(a={})=>{return async(b)=>{try{let c=await k.getEnvList(a);return b({type:h.TCB_SET_ENV_LIST,data:c.env_list}),c.env_list}catch(c){(!a.hasOwnProperty('showTips')||a.showTips)&&b({type:h.INFO_SHOW_ERROR,data:{message:c.toString()}})}}},K=(a)=>{return{type:h.TCB_SELECT_ENV,data:a}},L=(a)=>{return async(c,d)=>{const g=`getTcbFuncList-${+new Date}`;try{a.showTips&&u.add({id:g,name:e.config.TCB_GET_FUNC_LIST,type:'getTcbFuncList',progressIndeterminate:!0,status:'pending'});let j=await I(c,d);if(!j)return;const i=d(),l=i.project.current||{},m=b.join(l.projectpath,l.cloudfunctionRoot);let n=`${Date.now()}${Math.random()}`,o=await k.getTcbFuncList({namespace:j,pageIndex:0,pageSize:f.FUNC_LIST_PAGE_SIZE}),p=[].concat(o.Functions);if(a.writeFile&&H(m,o.Functions),c({type:h.TCB_SET_SCF_LIST,data:{list:o.Functions,pageIndex:0,total:o.total,namespace:j,updateKey:n}}),o.total>f.FUNC_LIST_PAGE_SIZE){let b=parseInt((o.total-1)/f.FUNC_LIST_PAGE_SIZE);for(let d,e=1;e<b;e++)d=await k.getTcbFuncList({namespace:j,pageIndex:e,pageSize:f.FUNC_LIST_PAGE_SIZE}),p=p.concat(d.Functions),a.writeFile&&H(m,d.Functions),c({type:h.TCB_SET_SCF_LIST,data:{list:d.Functions,pageIndex:e,total:o.total,namespace:j,updateKey:n}})}return c({type:h.TCB_CLEAN_SCF_LIST,data:{namespace:j,updateKey:n}}),a.showTips&&u.markSuccess(g),p}catch(b){a.showTips&&(u.updateDetails(g,b.toString()),u.markFail(g,{buttonsTemplate:t.TEMPLATE.PROGRESS_DIALOG}))}}},M=(a)=>{return{type:h.TCB_CONSOLE_COMMAND,data:a}},N=(a)=>{return 1024>a?`${a} B`:1048576>a?`${(a/1024).toFixed(1)} KB`:`${(a/1024/1024).toFixed(1)} MB`},O=(a)=>{let b=[];return a.hasOwnProperty('packSize')&&b.push(`上传包大小：${N(a.packSize)}`),a.hasOwnProperty('filesCount')&&b.push(`文件数量：${a.filesCount}`),b.join('\uFF0C')},P=(c)=>{const d=(c,e)=>{if(!a.existsSync(c))return e;const f=new Set,g=new Set;for(const a of e)a.includes('/')?g.add(a):f.add(a);if(f.size){const b=new Set(a.readdirSync(c)),d=new Set([...f].filter((a)=>!b.has(a)));if(d.size)return d}if(g.size){const a={};for(const b of g){const[c,...d]=b.split('/');a[c]||(a[c]=new Set),a[c].add(d.join('/'))}for(const e in a){const f=d(b.join(c,e),a[e]);if(f.size)return f}}return new Set};if(a.existsSync(c)){const e=JSON.parse(a.readFileSync(c,'utf8'));if(e.dependencies){const a=new Set(Object.keys(e.dependencies)),f=b.join(b.dirname(c),'node_modules');return d(f,a)}}},Q=async(a)=>{return new Promise(async(b,c)=>{let e=!1;const{namespace:f,functionName:g,onStatusUpdate:h=v,maxWaitTimeout:i=900000}=a,j=setTimeout(()=>{e||(e=!0,c(new Error('timeout waiting for function to deploy')))},i);try{let a='';for(const c=+new Date;!e&&+new Date-c<i;){const c=await k.getTcbFuncInfo({namespace:f,functionName:g});switch(global.appConfig.isDev&&console.warn('info for func',g,c),c.Status){case o.FUNCTION_STATUS.Creating:{a!==c.Status&&h(c.Status);break}case o.FUNCTION_STATUS.Updating:{a!==c.Status&&h(c.Status);break}case o.FUNCTION_STATUS.CreateFailed:throw new Error(`创建云函数失败：${c.StatusDesc}`);case o.FUNCTION_STATUS.UpdateFailed:throw new Error(`更新云函数失败：${c.StatusDesc}`);case o.FUNCTION_STATUS.Active:{e=!0,b();break}}}}catch(a){global.appConfig.isDev&&(console.trace(),console.error(a));try{d.error(`upload ${f} ${g} failed: `,'string'==typeof a?a:JSON.stringify(a))}catch(a){d.error(`upload ${f} ${g} failed: `,a.toString())}clearTimeout(j),c(a)}})},R=(c)=>{return async(f,h)=>{async function l(){const e=+new Date,l=await I(f,h);if(!l)return!1;const{dirPath:p,showTips:q,runtime:t,syncFunctions:v,createFunction:y,installDependency:D}=c;if(!D)try{const a=b.join(p,'package.json'),c=P(a);if(c.size){const a=await((a)=>new Promise((b)=>{f(i.setConfirmInfo({show:!0,content:`云函数中有以下未安装的依赖，如果未安装即全量上传，有可能云函数无法使用，是否确认上传？\n${[...a].join(', ')}`,callback:(a)=>{b(a)}}))}))(c);if(!a)return!1}}catch(a){d.error(`uploadTcbFunc check npm failed with error: ${a.toString()}}`)}let H=w;u.updateDetails(n,H);try{if(!y){const a=await k.getTcbFuncInfo({namespace:l,functionName:m});if(a.Status===o.FUNCTION_STATUS.Updating)throw new Error('\u68C0\u6D4B\u5230\u4E0E\u6B63\u5728\u8FDB\u884C\u4E2D\u7684\u53E6\u4E00\u4E2A\u8BE5\u4E91\u51FD\u6570\u7684\u66F4\u65B0\u8BF7\u6C42\u51B2\u7A81\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5');H=x,u.updateDetails(n,H);let b=D?'TRUE':'FALSE';if(r(D?'tcb_upload_func_install_dependency':'tcb_upload_func_full',!0),b!==a.InstallDependency){q&&(H=z,u.updateDetails(n,H));await k.updateTcbFuncConfig({namespace:l,functionName:m,config:{InstallDependency:b}})}}(async function(c,d){const e=b.join(d,'config.json');if(!a.existsSync(e))return;let f=a.readFileSync(e,'utf8');try{f=JSON.parse(f)}catch(a){return}if(f.permissions&&f.permissions.openapi){if(!Array.isArray(f.permissions.openapi)||!f.permissions.openapi.every((a)=>'String'===Object.prototype.toString.call(a).slice(8,-1)))throw new Error('config.json \u914D\u7F6E\u6587\u4EF6\u4E2D\u7684 permissions.openapi \u5FC5\u987B\u662F\u5408\u6CD5\u7684\u5B57\u7B26\u4E32\u6570\u7EC4');await s({url:g.updateSCFConfig,method:'post',needToken:1,needAppID:1,body:JSON.stringify({func_name:c,api_whitelist:f.permissions.openapi})})}})(m,p).catch((a)=>{f(j.addNotices([{id:Math.random()+new Date,name:`更新云函数 ${m} 的云调用权限失败`,time:+new Date,details:a.toString().split('\n'),icon:'fail',type:'task',combinable:!1}]))}),H=B,u.updateDetails(n,H);const c=await k.uploadTcbFunc({functionName:m,dirPath:p,runtime:t,namespace:l,installDependency:D,onStatusUpdate:(a)=>{switch(a){case o.IDE_UPLOAD_STATUS.COMPRESSING:{H=A,u.updateDetails(n,H);break}case o.IDE_UPLOAD_STATUS.UPLOADING:{H=C,u.updateDetails(n,H);break}}}}),d=O(c);u.updateDetails(n,`${G}\n${d}`),H=D?F:E;const i=+new Date;return await Q({namespace:l,functionName:m,onStatusUpdate:(a)=>{switch(a){case o.FUNCTION_STATUS.Creating:{u.updateDetails(n,E);break}case o.FUNCTION_STATUS.Updating:{D?u.updateDetails(n,F):u.updateDetails(n,E);break}}}}),D&&r('perf_biz_tcb_upload_func_wait_online_dep',!1,(+new Date-i).toFixed(0).toString()),H=G,u.updateDetails(n,H),v&&L({showTips:!1,writeFile:!1})(f,h),D?r('perf_biz_tcb_upload_func_online_dep',!1,(+new Date-e).toFixed(0).toString()):r('perf_biz_tcb_upload_func_full_upload',!1,(+new Date-e).toFixed(0).toString()),!0}catch(a){throw console.error('uploadTcbFunc fail',a),a&&'ResourceNotFound.FunctionName'===a.rawErrCode&&L({showTips:!1,writeFile:!1})(f,h),a}}const m=b.basename(c.dirPath),n=`upload-${m}-${+new Date}`;try{u.add({id:n,name:e.config.TCB_UPLOAD_FUNCTION.format(m),type:'uploadTcbFunction',progressIndeterminate:!0,status:'pending'});const a=await l();a?u.markSuccess(n):u.deleteProgress(n)}catch(a){u.updateDetails(n,a.toString()),u.markFail(n,{buttonsTemplate:t.TEMPLATE.PROGRESS_DIALOG})}}},S=(d)=>{return async(f,g)=>{const i=d.namespace||(await I(f,g));if(i){const g=`downloadTcbFunc-${+new Date}`;u.add({id:g,name:e.config.TCB_DOWNLOAD_FUNCTION.format(d.functionName),type:'downloadTcbFunc',progressIndeterminate:!0,status:'pending'});try{let e=await n.getFunctionData({functionName:d.functionName,forceUpdate:!0,namespace:i});if(d.writeFile)for(var j in e){let f=b.join(d.dirPath,j),g=b.dirname(f);c.sync(g),a.writeFileSync(f,e[j])}f({type:h.TCB_SET_FILE,data:{functionName:d.functionName,fileList:Object.keys(e),namespace:i}}),u.markSuccess(g)}catch(a){u.updateDetails(g,a.toString()),u.markFail(g,{buttonsTemplate:t.TEMPLATE.PROGRESS_DIALOG})}}}};module.exports={getEnvList:J,selectEnv:K,getTcbFuncList:L,uploadTcbFunc:R,consoleCommand:M,showActionMsg:(a)=>{return{type:h.TCB_SCF_INFO,data:{show:!0,message:a}}},setConfirmInfo:(a)=>{return{type:h.TCB_SCF_INFO,data:a}},showConsoleAddSCF:()=>{return async(a,b)=>{const c=p.getCurrentTcbInfo(),d=await I(a,b);if(d){let b=l.get(m.WINDOW_REGISTRY.CLOUD_CONSOLE);b?b.focus():a({type:h.WINDOW_SET_CLOUD,data:{console:{show:!0}}}),a(M({command:'SHOW_CREATE_SCF',data:{namespace:d,envId:c.currentEnv&&c.currentEnv.id}}))}}},downloadTcbFunc:S,downloadAllTcbFunc:(d)=>{return async(f,g)=>{const i=g(),j=i.project.current.cloudfunctionRoot,k=await I(f,g);if(k){const m=`downloadAllTcbFunc-${+new Date}`;u.add({id:m,name:e.config.TCB_DOWNLOAD_ALL_FUNCTION,type:'downloadAllTcbFunc',progressIndeterminate:!0,status:'pending'});let i=[];try{const o=(await L(d)(f,g))||[];for(let g,p=0,q=o.length;p<q;p++){g=o[p],u.updateDetails(m,e.config.TCB_DOWNLOAD_FUNCTION.format(g.FunctionName));try{let e=await n.getFunctionData({functionName:g.FunctionName,forceUpdate:d.forceUpdate,namespace:k});if(d.writeFile){let d=b.join(j,g.FunctionName);for(var l in e){let f=b.join(d,l),g=b.dirname(f);c.sync(g),a.writeFileSync(f,e[l])}}f({type:h.TCB_SET_FILE,data:{functionName:g.FunctionName,fileList:Object.keys(e),namespace:k}})}catch(a){i.push(a.toString()),u.updateDetails(m,i.join('\n')),u.markFail(m,{buttonsTemplate:t.TEMPLATE.PROGRESS_DIALOG})}}0===i.length&&u.markSuccess(m)}catch(a){u.updateDetails(m,a.toString()),u.markFail(m,{buttonsTemplate:t.TEMPLATE.PROGRESS_DIALOG})}}}},setLoading:(a)=>{return{type:h.TCB_SET_LOADING,data:a}},uploadTcbFunctions:(a)=>{return async(b,c)=>{const d=a.dirPaths;for(let e,f=0;f<d.length;f++)e=d[f],await R({showTips:a.showTips,syncFunctions:!1,dirPath:e})(b,c);L({showTips:!1,writeFile:!1})(b,c)}},uploadTcbFuncTriggers:(c)=>{return async(d,f)=>{const g=await I(d,f);if(!g)return;const{dirPath:h,showTips:i,syncFunctions:j}=c,l=b.basename(h),m=`deleteTcbFuncTriggers-${+new Date}`;u.add({id:m,name:e.config.TCB_UPLOAD_TRIGGERS.format(l),type:'deleteTcbFuncTriggers',progressIndeterminate:!0,status:'pending'});let n=w;try{n=y,u.updateDetails(m,n);const c=b.join(h,'config.json');if(!a.existsSync(c))throw new Error('\u672A\u627E\u5230\u4E91\u51FD\u6570\u914D\u7F6E\u6587\u4EF6 config.json');let d=a.readFileSync(c,'utf8');try{d=JSON.parse(d)}catch(a){throw new Error(`JSON 解析 config.json 失败，请确认文件是标准 JSON 格式, ${a}`)}if(!d.triggers||!Array.isArray(d.triggers))throw new Error('\u8BF7\u786E\u8BA4 config.json \u4E2D\u5305\u542B\u5408\u6CD5\u7684 triggers \u5B57\u6BB5');n=D,u.updateDetails(m,n),await k.batchCreateTcbFuncTriggers({namespace:g,functionName:l,count:d.triggers.length,triggers:d.triggers.map((a,b)=>{if('Object'===!Object.prototype.toString.call(a).slice(8,-1))throw new Error(`triggers[${b}] 定义必须是合法对象`);if(!a.name)throw new Error(`triggers[${b}] 缺少必填参数 name`);if(!a.type)throw new Error(`triggers[${b}] 缺少必填参数 type`);switch(a.type){case'timer':{if(!a.config)throw new Error(`triggers[${b}] 缺少必填参数 config`);break}default:}return{TriggerName:a.name,Type:a.type,TriggerDesc:a.config}})}),n=G,u.updateDetails(m,''),u.markSuccess(m)}catch(a){console.error('uploadTcbFuncTriggers fail',a),u.updateDetails(m,a.toString()),u.markFail(m,{buttonsTemplate:t.TEMPLATE.PROGRESS_DIALOG})}}},deleteTcbFuncTriggers:(a)=>{return async(c,d)=>{const f=`deleteTcbFuncTriggers-${+new Date}`;try{const g=await I(c,d);if(!g)return;const{dirPath:h}=a,i=b.basename(h);u.add({id:f,name:e.config.TCB_DELETE_TRIGGERS.format(i),type:'deleteTcbFuncTriggers',progressIndeterminate:!0,status:'pending'}),await k.batchCreateTcbFuncTriggers({namespace:g,functionName:i,count:0,triggers:[]}),u.markSuccess(f)}catch(a){console.error('deleteTcbFuncTriggers fail',a),u.updateDetails(f,a.toString()),u.markFail(f,{buttonsTemplate:t.TEMPLATE.PROGRESS_DIALOG})}}},downloadTcbFunctions:(a)=>{return async(c,d)=>{for(let e,f=0;f<a.functionNames.length;f++)e=a.functionNames[f],await S(_extends({},a,{dirPath:b.join(a.dirPath,e),functionName:e}))(c,d)}},setCurrentEnv:(a)=>{return async(b)=>{const c=p.getCurrentTcbInfo();let d=c.envList;if(0>=d.length){let a=await k.getEnvList();b({type:h.TCB_SET_SCF_LIST,data:a.env_list}),d=a.env_list}const e=d.findIndex((b)=>{return b.namespace==a});-1!=e&&b(K(e))}}}}(require('lazyload'),require);
'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('react'),{Provider:b}=require('react-redux'),c=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),d=require('./db2217eb4cff896bdcbc50abe005058f.js'),e=require('react-dom'),{validType:f,tokenManager:g}=require('./dc244a5ba483ad6e0acd267d3b91b282.js'),h=require('./f15811258ec83bc7d2978d66ddd5ed8a.js');class i extends a.Component{constructor(a){super(a),this.state={mount:!0}}render(){return this.state.mount?a.createElement('div',_extends({},this.props,{style:{width:'100%',height:'100%'}}),this.props.children):a.createElement('div',null)}}module.exports=class extends a.Component{constructor(a){super(a),this._onMessage=this.onMessage.bind(this)}componentDidMount(){window.addEventListener('message',this._onMessage),this.openWindow(this.props.url)}componentWillReceiveProps(a){a.url!==this.props.url&&this.child&&(this.props.webview?this.setupWebview(a.url):this.child.window.location.href=a.url)}componentWillUnmount(){if(this.unmounted=!0,this.child)try{this.closeWindow()}catch(a){}window.removeEventListener('message',this._onMessage),this.webview&&h.disable(this.webview)}openWindow(){let a=this.props.webview?`html/plugin-webview.html?pluginid=${this.props.pluginId}`:`html/plugin-window.html?pluginid=${this.props.pluginId}`;if(this.props.searchParams)for(const b in this.props.searchParams)a+=`&${b}=${this.props.searchParams[b]}`;nw.Window.open(a,this.getWindowOptions(),(a)=>{return a?this.unmounted?void a.close(!0):void(this.registryId=this.props.registryId,this.child=a,a.on('close',()=>{setTimeout(this.closeWindow.bind(this),100),this.props.onWindowClose&&this.props.onWindowClose(a)}),a.on('new-win-policy',(a,b,c)=>{console.log(a,b,c),c.forceCurrent()}),this.props.persistId&&this.localizeLocalStorage(a.window.localStorage,this.props.persistId),this.props.onWindowOpen&&this.props.onWindowOpen(a),this.registryId&&(d.register({id:this.registryId,window:a}),global.windowMap.set(this.registryId,a)),this.props.scriptSource&&this.setupWindow(this.props.scriptSource)):void(this.props.onWindowOpenFail&&this.props.onWindowOpenFail())})}setupWebview(d){let j=!1;if(!this.webview){j=!0;const a=g.getSessionToken(f.UA_TOKEN);this.webview=this.child.window.document.getElementById('webview'),this.webview.setUserAgentOverride(`${navigator.userAgent} wechatdevtools wechatideplugin port/${global.messageCenterPort} ${this.props.userAgent||''} token/${a}`)}if(this.webview.src=d,window.consoleWebview=this.webview,this.props.children){const d=document.createElement('div');this.child.window.document.body.appendChild(d),e.render(a.createElement(b,{store:c},a.createElement(i,_extends({ref:(a)=>this.dummy=a},this.props.wrapperProps),this.props.children)),d)}j&&this.props.enableContextMenu&&h.enable(this.webview)}setupWindow(a){const b=this.child.window.document,c=b.createElement('script');c.src=a,'loading'===b.readyState?b.onreadystatechange=function(){('interactive'===b.readyState||'complete'===b.readyState)&&b.head.appendChild(c)}:b.head.appendChild(c)}closeWindow(){this.child&&(this.registryId&&d.unregister(this.registryId),this.child.close(!0),this.child=null)}ensureCloseWindow(){try{this.child.close(!0)}catch(a){}}getWindowOptions(){return function(a){const b={};for(let c of a)this.props.hasOwnProperty(c)&&(b[c]=this.props[c]);return b}.bind(this)(['id','title','icon','position','always_on_top','width','height','min_width','min_height','max_width','max_height','resizable','kiosk','fullscreen','show_in_taskbar','frame','transparent'])}onMessage(a){'PLUGIN_READY'==a.data&&this.props.webview&&this.setupWebview(this.props.url)}localizeLocalStorage(a,b){a.getItem=function(a){return localStorage.getItem(`${b}:${a}`)}.bind(a),a.setItem=function(a,c){return localStorage.setItem(`${b}:${a}`,c)}.bind(a),a.removeItem=function(a){return localStorage.removeItem(`${b}:${a}`)}.bind(a),a.clear=function(){}.bind(a)}render(){return a.createElement('div',{style:{display:'none'}})}}}(require('lazyload'),require);
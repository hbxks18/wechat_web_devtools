;!function(require, directRequire){;"use strict";const tslib_1=require("tslib"),interruptibletask_1=require('./f87c21baecac660695b0d3124dbebed6.js'),{connect}=require("react-redux"),React=require("react"),moment=require("moment"),upload=require('./f0466135fc8b3a662084784e5f4ac792.js'),clickkeyConfig=require('./eadce02c750c875a10680bcfedadec88.js'),compileTypeConfig=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),infoActions=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),consoleActions=require('./2f0aa63ae61d48294b5e9927ab57e1a4.js'),toolbarActions=require('./fc137838572a83604db39acff8e909e0.js'),projectActions=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),tools=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),remoteDebug=require('./63f52c9055d92f52ca0510da7d3dcadb.js'),windowActions=require('./a8c87029da0fa06e986298d447ab0fe2.js'),beforePreview=require('./e4d68def70709dc877cb2ba5bdad18cb.js'),settingsActions=require('./e98c60a262d8d98e69e574a9d12a21df.js'),shortcuts=require('./9355620dfff47077fc5946269d43cd4d.js'),appErrcodeConfig=require('./949d8235c744ced2a80121e4dba34c28.js'),simulatorTypeConfig=require('./efd8b4323f89b2a759d044d894e3a4f0.js'),{getAvailablePort}=require('./84b183688a46c9e2626d3e6f83365e13.js'),locales=require('./common/locales/index.js'),pointerStyle={cursor:"pointer"},mapStateToProps=(a,b)=>{const c=(a.settings.shortcuts||{}).preview,d=shortcuts.getDisplayTextFromShortcut(c),e=a.project.current||{},f=e.runtimeAttr||{},g=f.authQY;return{show:clickkeyConfig.PREVIEWCODE===a.toolbar.clickKey||clickkeyConfig.REMOTEDEBUGCODE===a.toolbar.clickKey,appConfig:a.simulator.appConfig||{},project:e,plugin:a.plugin,authQY:g,nickName:(a.user||{}).nickName||locales.config.UNKNOWN_USER,headUrl:(a.user||{}).headUrl,remoteDebug:"remotedebug"===b.mode,remoteDebugWindow:a.window.remoteDebugWindow,compilerSettings:a.settings.compiler||{},displayShortcuts:d}},mapDispatchToProps=(a)=>({showError:tools.bindActionCreators(infoActions.showError,a),setConfirmInfo:tools.bindActionCreators(infoActions.setConfirmInfo,a),toggleClickKey:tools.bindActionCreators(toolbarActions.toggleClickKey,a),setPkgSize:tools.bindActionCreators(projectActions.setPkgSize,a),showSuccessTip:tools.bindActionCreators(infoActions.showSuccessTip,a),windowActions:tools.bindActionCreators(windowActions,a),consoleActions:tools.bindActionCreators(consoleActions,a),updateIDESetting:tools.bindActionCreators(settingsActions.updateIDESetting,a),autoPreview:tools.bindActionCreators(toolbarActions.autoPreview,a)});let PreviewQRCode=class extends React.Component{constructor(a){super(a),this.onProgressUpdateFn=(a="",b="")=>{console.log("progress stage",a,"detailedText",b),this.setState({progressDetailedText:b,stage:a})},this.onHandleClick=(a)=>{a.stopPropagation()},this.handleIconAskClick=(a)=>{a.stopPropagation();try{nw.Shell.openExternal("https://developers.weixin.qq.com/miniprogram/dev/devtools/mydev.html")}catch(a){console.warn("open external failed.")}},this.showPreviewTool=(a)=>{a.stopPropagation(),this.setState({previewToolShown:!0})},this.handleTipsClick=(a)=>{a.stopPropagation();const b=this.state.tipsShow,c=this.props.top+20;this.setState({tipsShow:!b,tipsTop:c})},this.handleTipsLinkClick=(a)=>{a.stopPropagation();try{nw.Shell.openExternal("https://developers.weixin.qq.com/blogdetail?action=get_post_info&docid=000e0696f084e0b0f21613f6a51804")}catch(a){console.warn("open external failed.")}},this.handleTriggerAutoPreviewClick=(a)=>{a.stopPropagation(),this.props.autoPreview()},this.state={loading:!0,show:a.show,src:"",tipsShow:!1,previewToolShown:!1,filesIgnored:[],remoteDebugEvents:[],filesMissing:[]},this.previewTimer=null,this._mounted=!1}componentDidMount(){this._mounted=!0,(!this.props.compilerSettings.autoPreview||this.props.remoteDebug)&&this.loadQRCode()}componentWillReceiveProps(a){a.show!==this.props.show&&this.setState({show:a.show}),a.show&&a.timeStamp!==this.props.timeStamp&&(a.remoteDebug||!this.props.compilerSettings.autoPreview)&&this.loadQRCode()}componentWillUnmount(){this._mounted=!1,clearTimeout(this.previewTimer),beforePreview.abort(),this.uploadTask&&(this.uploadTask.abort(),this.uploadTask=void 0),this.props.remoteDebug&&!this.props.remoteDebugWindow.show&&(null!==this.state.remoteDebugStatus&&remoteDebug.destroy(),this.props.project.projectid===this.props.remoteDebugWindow.debuggingProjectId&&this.props.windowActions.setRemoteDebugWindow({debuggingProjectId:null}))}async beforePreview(){const a=this.props,b=a.project;if(b&&b.setting&&b.setting.scriptsEnable&&b.scripts&&b.scripts.beforePreview){this.onProgressUpdateFn("custombeforepreview",locales.config.CONSOLE_PREPROCESS_RUNNING),a.consoleActions.clear(),a.consoleActions.log(locales.config.CONSOLE_PREPROCESS_START);try{await beforePreview.run({command:b.scripts.beforePreview,options:{cwd:b.projectpath,shell:!0},stderr:a.consoleActions.error,stdout:a.consoleActions.log})}catch(b){throw a.consoleActions.error(locales.config.CONSOLE_PREPROCESS_ERROR),new Error(locales.config.CONSOLE_PREPROCESS_ERROR)}this.onProgressUpdateFn("custombeforepreview",locales.config.CONSOLE_PREPROCESS_SUCCESS)}}formatUploadOptions(){const a=this.props,b=a.project,c=b.compileType,d={test:!0,onProgressUpdate:this.onProgressUpdateFn,onFilesIgnored:(a=[])=>{this.setState({filesIgnored:a})},onFilesMissing:(a=[])=>{this.setState({filesMissing:a})},remoteDebug:a.remoteDebug,remoteDebugLocal:global.l,remoteProxyPort:void 0,disableUrlCheck:a.remoteDebugWindow.disableUrlCheck,autoPreview:a.compilerSettings.autoPreview,cdpEnabled:"game"===b.compileType,noMaps:a.remoteDebugWindow.noMaps},e=b.condiction[c],f=e.list[e.current];return c===compileTypeConfig.search?f&&(d.searchQuery=f.customQuery||f.query,d.boxQI=f.customQuery?"":f.boxQI):(c===compileTypeConfig.weapp||c===compileTypeConfig.plugin)&&(d.page=f?f.pathName:this.props.appConfig.pages[0],d.query=f?f.query:""),b.attr.gameApp&&(d.query=f?f.query:""),d}async initRemoteDebug(a){const b=this.props;if(!b.remoteDebug)return;const{wxpkg_info:c="",room_id:d="",qrcode_img:e="",username:f=""}=a;if(!c||!d||!e)throw new Error("invalid request");let g=await remoteDebug.init(b.project,{wxpkg_info:c,room_id:d,username:f,appid:b.project.appid},{usingLocalStorage:b.remoteDebugWindow.usingLocalStorage,remoteDebugLocal:global.l,clientProxyPort:void 0,onStatusUpdate:(b,c)=>{this.state.show&&(c&&g&&g.url?(this.props.windowActions.setRemoteDebugWindow({show:!0,inspectUrl:g.url,serverInfo:a}),this.hideQrCodeWin()):this.setState({remoteDebugStatus:b}))},onProgressUpdate:this.onProgressUpdateFn,onEvent:(a)=>{this.state.show&&this.setState({remoteDebugEvents:(this.state.remoteDebugEvents||[]).concat(a)})},isGame:"game"===b.project.compileType})}loadQRCode(){this.setState({loading:!0,filesIgnored:[],filesMissing:[],tipsShow:!1,stage:null,src:"",remoteDebugStatus:null,remoteDebugEvents:[]}),this.previewTimer=setTimeout(async()=>{try{await this.beforePreview(),this.uploadTask=upload(this.formatUploadOptions());const a=await this.uploadTask;if(this.uploadTask=void 0,!this._mounted)return;await this.initRemoteDebug(a);const b=new Date,c=moment(b).format("M.DD HH:mm"),d=moment(+b+1500000).format("M.DD HH:mm");this.setState({generateTime:c,qrcode_time:d,src:`data:image/png;base64,${a.qrcode_img}`,loading:!1,progressDetailedText:"",stage:null}),this.props.setPkgSize({preview:a.wxpkg_size,previewSubpackages:a.subpackage_info,lastPreviewTime:+new Date})}catch(a){if(!this._mounted)return;if(a===interruptibletask_1.AbortEvent)return;a.code===appErrcodeConfig.FILE_FLAT_ERR?this.props.setConfirmInfo({show:!0,type:"error",title:locales.config.COULD_NOT_USE_CODE_PROTECT,content:a.message,showCancel:!0,showConfirm:!0,cancelText:locales.config.CLOSE,confirmText:locales.config.READ_DOCUMENTATION,callback:(a)=>{a&&nw.Shell.openExternal("https://developers.weixin.qq.com/miniprogram/dev/devtools/project.html#%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4")}}):this.props.showError(a instanceof Error?a:new Error(a)),this.hideQrCodeWin()}})}hideQrCodeWin(){this._mounted&&(this.setState({show:!1}),this.props.toggleClickKey(clickkeyConfig.NONE))}onCopyClick(a,b){b.stopPropagation();let c=this.imgdom;"preview"===a&&(c=this.previewImgDom);const{left:d,top:e,height:f,width:g}=c.getBoundingClientRect(),h=()=>{const a=global.windowMap.get("MAIN"),b=a.window.document.body.offsetWidth;a.capturePage((a)=>{const h=document.createElement("canvas"),c=h.getContext("2d");h.height=f,h.width=g;const i=new Image;i.onload=()=>{const a=i.width/b;c.drawImage(i,d*a,e*a+5,g*a,f*a-5,0,0,g,f);const j=nw.Clipboard.get();j.set(h.toDataURL(),"png"),this.props.showSuccessTip(locales.config.CONSOLE_COPY_SUCCESS)},i.src=a},{format:"png",datatype:"datauri"})};this._blinkTimeout||(c.style.opacity=0.6,this._blinkTimeout=setTimeout(()=>{c.style.opacity=1,this._blinkTimeout=null,setTimeout(()=>h(),20)},200))}handleWarningAskClick(a){a.stopPropagation();try{nw.Shell.openExternal("https://developers.weixin.qq.com/miniprogram/dev/devtools/debug.html#%E7%BC%96%E8%AF%91%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF")}catch(a){console.warn("open external failed.")}}showScanCode(a){a.stopPropagation(),this.setState({previewToolShown:!1})}handleAutoPreviewClick(a){a===!!this.props.compilerSettings.autoPreview||(this.props.updateIDESetting("compiler","autoPreview",a),a?this.props.autoPreview():this.loadQRCode())}renderMissingFileTip(){return!this.state.loading&&0<(this.state.filesIgnored||[]).length+(this.state.filesMissing||[]).length?React.createElement("p",{style:{fontWeight:600,marginBottom:"10px",textAlign:"center"}},React.createElement("a",{style:{color:"#586c94"},onClick:this.handleTipsClick},locales.config.COMPILE_EXCEPTION,(this.state.filesIgnored||[]).length+(this.state.filesMissing||[]).length)):null}renderMissingFileDetail(){if(!this.state.tipsShow)return null;const a=this.state.filesMissing||[],b=this.state.filesIgnored||[];return React.createElement("div",{onClick:this.onHandleClick,className:"ui-popover",style:{left:"262"}},React.createElement("div",{className:"previewer"},React.createElement("div",{className:"previewer-header"},React.createElement("h4",null,locales.config.EXCEPTION_INFORMATION,React.createElement("i",{className:"ui-icon-ask",style:pointerStyle,title:locales.config.CLICK_FOR_DETAIL,onClick:this.handleWarningAskClick.bind(this)}))),React.createElement("div",{className:"previewer-body"},React.createElement("div",{className:"previewer-msg-area"},0<a.length&&React.createElement("div",{className:"previewer-msg-group"},React.createElement("h5",null,locales.config.PREVIEW_MSG_FILE_IGNORED),React.createElement("p",{style:{color:"gray"}},locales.config.PREVIEW_MSG_NOT_UPLOAD_FILES),React.createElement("ul",null,a.slice(0,100).map((a,b)=>React.createElement("p",{key:b},"\xB7 "+a)),100<a.length?React.createElement("p",null,"(",a.length-100," items not shown)"):null)),0<b.length&&React.createElement("div",{className:"previewer-msg-group"},React.createElement("h5",null,locales.config.PREVIEW_MSG_BIG_FILE),React.createElement("p",{style:{color:"gray"}},locales.config.PREVIEW_MSG_BIG_FILE_DETAILS,React.createElement("a",{style:{color:"#586c94"},onClick:this.handleTipsLinkClick},locales.config.CLICK_FOR_DETAIL)),React.createElement("ul",null,b.slice(0,100).map((a,b)=>React.createElement("p",{key:b},"\xB7 "+a)),100<b.length?React.createElement("p",null,"(",b.length-100," items not shown)"):null))))))}renderAuthQYTip(){return!this.props.authQY||this.state.loading||this.props.remoteDebug?null:React.createElement("div",{className:"preview-qrcode-title"},React.createElement("p",null,locales.config.WXWORK_SCAN_QR_CODE))}renderRemoteDebugStatus(){if(!this.props.remoteDebug)return null;const a=this.state.remoteDebugStatus;if("number"!=typeof a)return null;return-1===a?React.createElement("span",{style:{color:"red",fontWeight:600}},locales.config.REMOTE_DEBUG_END):0===a?React.createElement("span",{style:{color:"red",fontWeight:600}},locales.config.REMOTE_DEBUG_NOT_UNINITIALIZED):1===a?React.createElement("span",{style:{color:"red",fontWeight:600}},locales.config.REMOTE_DEBUG_NOT_CONNECTED):2===a?React.createElement("span",{style:{color:"red",fontWeight:600}},locales.config.REMOTE_DEBUG_LOGOUT):3===a?React.createElement("span",{style:{fontWeight:600}},locales.config.REMOTE_DEBUG_LOGINING):4===a?locales.config.REMOTE_DEBUG_WAIT_SERVICE:5===a?React.createElement("span",{style:{fontWeight:600}},locales.config.REMOTE_DEBUG_SERVER_BLOCKING):6===a?locales.config.REMOTE_DEBUG_WAITING_FOR_RESPONSE:7===a?locales.config.REMOTE_DEBUG_WORK_CORRECTLY:React.createElement("span",{style:{color:"red",fontWeight:600}},locales.config.REMOTE_DEBUG_UNKNOWN)}renderRemoteDebugEvent(){const a=this.state.remoteDebugEvents||[];return a.map((a,b)=>React.createElement("p",{key:b,style:{color:"gray",fontSize:"11px"}},a.type+", "+(a.message||"")))}render(){const a=this.props;let b=a.compilerSettings.autoPreview;const c=a.remoteDebug,d="game"===a.project.compileType,e=this.props.project.simulatorType,f=this.props.plugin.pluginManifests;let g;e===simulatorTypeConfig.wechat?g=!0:f[e]&&f[e].unsupportedFunctionalities&&(g=!f[e].unsupportedFunctionalities.includes("auto-preview")),b=g&&b;let h;return c?h=React.createElement("h4",{className:"previewer-header-active"},locales.config.QR_CODE_REMOTE_DEBUG):g?b?h=[React.createElement("h4",{key:"scanQRCode",onClick:this.handleAutoPreviewClick.bind(this,!1)},locales.config.QR_CODE_PREVIEW),React.createElement("h4",{key:"autoPreview",className:"previewer-header-active"},locales.config.AUTO_PREVIEW)]:h=[React.createElement("h4",{key:"scanQRCode",className:"previewer-header-active"},locales.config.QR_CODE_PREVIEW),React.createElement("h4",{key:"autoPreview",onClick:this.handleAutoPreviewClick.bind(this,!0)},locales.config.AUTO_PREVIEW)]:(h=React.createElement("h4",{key:"scanQRCode"},locales.config.QR_CODE_PREVIEW),this.handleAutoPreviewClick(!1)),React.createElement("div",null,React.createElement("div",{className:"preview-group",style:{position:"absolute",top:this.props.top,left:this.props.left,display:this.state.show?"":"none",width:"262"}},React.createElement("div",{className:"preview-item"},React.createElement("div",{className:"ui-popover",style:{position:"relative",width:"262"},onClick:this.onHandleClick},React.createElement("div",{className:"previewer"},React.createElement("div",{className:"previewer-header",onClick:this.showScanCode.bind(this),style:pointerStyle},h)," ",React.createElement("div",{ref:(a)=>this.imgdom=a,style:{position:"relative",display:b&&!c?"none":""}},React.createElement("div",{className:"previewer-body",style:this.state.previewToolShown?{display:"none"}:{}},React.createElement("div",{className:"previewer-qrcode"},React.createElement("div",{className:"preview-qrcode-title",style:this.state.loading||a.remoteDebug?{display:"none"}:{}},React.createElement("p",null,locales.config.PREVIEW_QR_CODE_TITLE.format([this.props.nickName,this.state.generateTime||locales.config.UNKNOWN_TIME]))),this.renderAuthQYTip(),this.renderMissingFileTip(),c&&d&&this.state.src&&!this.state.loading?React.createElement("div",{className:"preview-qrcode-tips"},React.createElement("p",null,locales.config.PREVIEW_QR_CODE_TIP4.format(["iOS 11.2 ~ 11.4.1","6.7.2"]),", ",locales.config.PREVIEW_QR_CODE_TIP4_SHORT.format(["Android","6.7.3"]))):null,React.createElement("img",{onClick:this.onCopyClick.bind(this,"qrcode"),src:this.state.src?this.state.src:"../static/image/qrcode.png",style:{minHeight:"200px",visibility:this.state.src?"visible":"hidden"}}),React.createElement("div",{className:"previewer-loading",style:this.state.loading?{backgroundColor:"transparent"}:{display:"none"}},React.createElement("div",{className:"previewer-loading-content"},React.createElement("i",{className:"ui-icon-spinner"}),React.createElement("p",{className:"ui-desc"},this.state.progressDetailedText))),0<(this.state.filesIgnored||[]).length+(this.state.filesMissing||[]).length&&React.createElement("div",{className:"preview-qrcode-tips",style:this.state.loading?{backgroundColor:"transparent"}:{display:"none"}},React.createElement("p",null,React.createElement("a",{onClick:this.handleTipsClick},React.createElement("i",{className:"ui-icon-circle-x"}),React.createElement("span",null," ",locales.config.EXCEPTION_FOUND,(this.state.filesIgnored||[]).length+(this.state.filesMissing||[]).length),React.createElement("i",{className:"ui-icon-arrow-right-o"})))),React.createElement("div",{className:"preview-qrcode-tips"},React.createElement("p",{style:{display:this.state.qrcode_time?"":"none"}},React.createElement("span",null,locales.config.EXPIRE_AT_SOME_TIME.format(this.state.qrcode_time))))))),b&&!c&&React.createElement("div",null,this.props.autoUploadFailureText&&React.createElement("div",null,React.createElement("p",null,locales.config.PREVIEW_QR_CODE_ERR),React.createElement("pre",{style:{margin:"10px",textAlign:"left",fontSize:"12px",overflow:"auto"}},this.props.autoUploadFailureText)),!this.props.autoUploadFailureText&&React.createElement("div",{className:"previewer-qrcode"},React.createElement("div",{className:"preview-demo-img"},React.createElement("img",{src:a.headUrl,className:"preview-user-avatar"})),React.createElement("div",{className:"preview-qrcode-tips"},React.createElement("p",null,locales.config.PREVIEW_QR_CODE_TIP1.format(a.nickName)),React.createElement("p",null,locales.config.PREVIEW_QR_CODE_TIP2),React.createElement("p",null,locales.config.PREVIEW_QR_CODE_TIP3)))),React.createElement("p",null,this.renderRemoteDebugStatus()),this.renderRemoteDebugEvent(),b&&!a.remoteDebug?React.createElement("div",{className:"preview-footer"},"uploading"===a.autoUploadStatus?React.createElement("i",{className:"ui-icon-spinner"}):React.createElement("button",{onClick:this.handleTriggerAutoPreviewClick,title:a.displayShortcuts,className:"ui-button ui-button-default"},locales.config.COMPILE_AND_PREVIEW),React.createElement("div",{className:"preview-qrcode-tips"},React.createElement("p",null,locales.config.PREVIEW_QR_CODE_TIP_SHORTCUT.format(a.displayShortcuts||locales.config.NONE)))):React.createElement("div",{className:"preview-footer",style:this.state.previewToolShown?{display:"none"}:{}},!this.state.stage&&!a.remoteDebug&&React.createElement("div",null,React.createElement("button",{onClick:this.onCopyClick.bind(this,"qrcode"),className:"ui-button ui-button-default"},locales.config.COPY_QR_CODE))))),this.renderMissingFileDetail()),React.createElement("div",{className:"preview-item"},React.createElement("div",{className:"ui-popover",style:{position:"relative",width:"262",display:b||a.remoteDebug?"none":""},onClick:this.onHandleClick},React.createElement("div",{className:"previewer"},React.createElement("div",{className:"previewer-header",onClick:this.showPreviewTool,style:pointerStyle},React.createElement("h4",null,locales.config.MINI_PROGRAM_DEV_ASSISTANT,React.createElement("i",{className:"ui-icon-ask",style:pointerStyle,title:locales.config.CLICK_FOR_DETAIL,onClick:this.handleIconAskClick}))),React.createElement("div",{ref:(a)=>this.previewImgDom=a,style:this.state.previewToolShown?{}:{display:"none"}},React.createElement("div",{className:"previewer-body"},React.createElement("div",{className:"previewer-qrcode"},React.createElement("img",{onClick:this.onCopyClick.bind(this,"preview"),src:"../static/image/my-dev-apps.jpg",alt:""})))),React.createElement("div",{className:"preview-footer",style:this.state.previewToolShown?{}:{display:"none"}},React.createElement("button",{onClick:this.onCopyClick.bind(this,"preview"),className:"ui-button ui-button-default"},locales.config.COPY_QR_CODE)))))))}};PreviewQRCode=tslib_1.__decorate([locales.mixin],PreviewQRCode),module.exports=connect(mapStateToProps,mapDispatchToProps)(PreviewQRCode);
;}(require("lazyload"), require);

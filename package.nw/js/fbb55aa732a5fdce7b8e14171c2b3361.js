;!function(require, directRequire){;'use strict';const request=require('./15ba1827c7f6564a45df6bd44da3a977.js'),projectManager=require('./3bfffbe88b3d923921f851c0697974fe.js'),urlConfig=require('./f171257bbcaef547a3cf27266ccb0db2.js'),tools=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),errcodeConfig=require('./df6d0ff021a69fb541c733de4dbba0fe.js'),actionsConfig=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),locales=require('./common/locales/index.js'),DeprecatedTipInstance=1800000;let lastDeprecatedTipTime=0;async function login(a,b){const{body:c}=await request({url:`${urlConfig.jsLoginURL}`,method:'post',body:JSON.stringify({scope:['snsapi_base']}),needToken:1,needAppID:1});return{errMsg:`${b.api}:ok`,code:c.code}}async function refreshSession(a,b){const{body:c}=await request({url:`${urlConfig.jsRefreshSessionURL}`,method:'post',needToken:1,needAppID:1});return{errMsg:`${b.api}:ok`,expireIn:c.session_expire_in,err_code:c.baseresponse.errcode}}async function operateWXDataConfirm(a,b,c){return new Promise((d)=>{a({type:actionsConfig.SIMULATOR_SET_AUTHORIZE_CONFIRM,data:{show:!0,scopeList:c.scopeList,imageUrl:c.imageUrl,appName:c.appName,callback:async(a,c)=>{a=a&&c[0].checked;const{body:e}=await request({url:`${urlConfig.jsOperateWXDATAURL}`,method:'post',body:JSON.stringify({data:JSON.stringify(b.args.data||{}),grant_scope:c[0].scope,opt:a?1:2}),needToken:1,needAppID:1});return a?d({errMsg:`${b.api}:ok`,data:JSON.parse(e.data)}):d({errMsg:`${b.api}:fail auth deny`})}}})})}async function deprecatedTip(a){if(!(Date.now()-lastDeprecatedTipTime<DeprecatedTipInstance))return lastDeprecatedTipTime=Date.now(),new Promise((b)=>{a({type:actionsConfig.SIMULATOR_SET_CONFIRM,data:{show:!0,content:locales.config.GETUSERINFO_NOT_AUTHORIZED_WINDOW,showCancel:!0,cancelText:locales.config.CONTINUE_USE,confirmText:locales.config.VIEW_DETAILS,callback:async(a)=>{a&&!global.autoTest&&nw.Shell.openExternal('https://developers.weixin.qq.com/blogdetail?action=get_post_info&lang=zh_CN&token=1650183953&docid=0000a26e1aca6012e896a517556c01'),b()}}})})}async function operateWXData(a,b,c){const d=projectManager.getCurrent(),e=c(),{args:f,api:g}=b;if('webapi_getuserinfo'===f.data.api_name&&(1003000>projectManager.getLibVersionNumber()&&(delete f.data.lang,delete f.data.with_credentials),d.isTourist)){const a=e.user||{};return{errMsg:'operateWXData:ok',data:{data:JSON.stringify({nickName:a.nickName,avatarUrl:a.headUrl,gender:'male'===a.sex?1:2,province:a.province,city:a.city,country:a.country})}}}const{body:h}=await request({url:`${urlConfig.jsOperateWXDATAURL}`,method:'post',body:JSON.stringify({data:JSON.stringify(f.data||{})}),needToken:1,needAppID:1,needCheckErrCode:-1}),i=h.baseresponse;if(i){const c=h.baseresponse.errcode;if(0===c){const c=JSON.parse(h.data);try{const b=f.data&&f.data.api_name&&f.data.api_name.replace('webapi_','')||g;a({type:actionsConfig.SIMULATOR_UPDATE_DECRYPTED_INFO,api:b,data:{encryptedData:c.encryptedData,iv:c.iv,sessionKey:h.debug_info.session_key,decryptedData:h.debug_info.data}})}catch(a){}return{errMsg:`${b.api}:ok`,data:c}}if(c===errcodeConfig.NEED_CONFORM||global.online)return operateWXDataConfirm(a,b,{imageUrl:h.appicon_url,appName:h.appname,scopeList:[h.scope]});const d=tools.parseCgiErrorCode(c,i.errmsg);return'scope unauthorized'!==d||'webapi_getuserinfo'!==f.data.api_name||f.data.from_component||(await deprecatedTip(a)),{errMsg:`${b.api}:fail ${d}`}}}async function authorizeRequest(a,b){const{body:c}=await request({url:`${urlConfig.jsAuthorizeConfirmURL}`,method:'post',body:JSON.stringify({scope:b,opt:a?1:2}),needToken:1,needAppID:1});return c.baseresponse&&0===c.baseresponse.errcode?a?'ok':'fail auth deny':'fail request error'}async function userLocationAuthorizeConfirm(a,b,c){return new Promise((d)=>{a({type:actionsConfig.SIMULATOR_SET_CONFIRM,data:Object.assign({},c,{confirmText:locales.config.ALLOW,cancelText:locales.config.NOT_ALLOW,showCancel:!0,show:!0,callback:async(a)=>{const c=await authorizeRequest(a,['scope.userLocation']);d({errMsg:`${b.api}:${c}`})}})})})}async function authorizeConfirm(a,b,c){return new Promise((d)=>{a({type:actionsConfig.SIMULATOR_SET_AUTHORIZE_CONFIRM,data:Object.assign({},c,{show:!0,callback:async(a,c)=>{const e=[];c.forEach((a)=>{a.checked&&e.push(a.scope)});const f=await authorizeRequest(a,e);d({errMsg:`${b.api}:${f}`})}})})})}let authorizeQueue=[];async function processAuthorizeQueue(){for(;0<authorizeQueue.length;){const a=authorizeQueue[0];if(!a)break;try{const b=await a.fn();a.resolve(b)}catch(b){a.reject(b)}authorizeQueue.shift()}}async function authorize(a,b,c){const{scope:d}=b.args,e='scope.userLocation'===d[0];let f;if(e){const d=c(),e=d.simulator.appConfig;if(f=e&&e.permission&&e.permission['scope.userLocation']&&e.permission['scope.userLocation'].desc||'',!f)return a({type:actionsConfig.SIMULATOR_SET_CONFIRM,data:{show:!0,content:locales.config.NEED_PERMISSION_STATEMENT.format('authorize scope.userLocation'),showCancel:!0,confirmText:locales.config.VIEW_DETAILS,callback:(a)=>{a&&!global.autoTest&&nw.Shell.openExternal('https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#permission')}}}),{errMsg:`${b.api}:fail`}}const{body:g}=await request({url:`${urlConfig.jsAuthorizeURL}`,method:'post',body:JSON.stringify({scope:b.args.scope||[]}),needCheckErrCode:-1,needToken:1,needAppID:1}),h=g.baseresponse;if(h){const c=h.errcode;if(0===c)return{errMsg:`${b.api}:ok`,body:g};if(c===errcodeConfig.NEED_CONFORM)return await(async()=>new Promise((c,d)=>{e?authorizeQueue.push({fn:async()=>await userLocationAuthorizeConfirm(a,b,{title:locales.config.ASK_FOR_LOCATION_PERMISSION.format(g.appname),content:f}),resolve:c,reject:d}):authorizeQueue.push({fn:async()=>await authorizeConfirm(a,b,{imageUrl:g.appicon_url,appName:g.appname,scopeList:g.scope_list}),resolve:c,reject:d}),2>authorizeQueue.length&&processAuthorizeQueue()}))();const d=tools.parseCgiErrorCode(c,h.errmsg);return{errMsg:`${b.api}:fail ${d}`}}return{errMsg:`${b.api}:fail system error`}}async function openWeRunSetting(a,b){const{body:c}=await request({url:`${urlConfig.checkWeRunState}`,method:'post',body:JSON.stringify({appid:projectManager.getProjectAppID()}),needToken:1,needAppID:1}),d=c.state;if(1===d)return{errMsg:`${b.api}:ok`};const e=c.wording||locales.config.USER_NOT_OPEN_WECHAT_MOVEMENT;return a({type:actionsConfig.SIMULATOR_SET_CONFIRM,data:{show:!0,content:e,showCancel:!1,confirmText:locales.config.CLOSE}}),{errMsg:`${b.api}:fail ${e}`}}async function chooseInvoiceTitle(a,b){a({type:actionsConfig.SIMULATOR_SET_CHOOSEINVOICETITLE,data:{show:!0,callbackID:b.callbackID,api:b.api}})}async function openAddress(a,b){a({type:actionsConfig.SIMULATOR_SET_CHOOSEADDRESS,data:{show:!0,callbackID:b.callbackID,api:b.api}})}async function addPhoneContact(a,b){a({type:actionsConfig.SIMULATOR_SET_ADDPHONECONTACT,data:{show:!0,callbackID:b.callbackID,api:b.api,contactData:Object.assign({},b.args)}})}async function getPermissionBytes(a,b){const c=projectManager.getCurrentRuntimeConfig(),d=c.permissionBitset||'',e=d.split('').map((a)=>parseInt(a,10)),f=b.args.indexes||[];if(0===f.length)return{errMsg:`${b.api}:ok`,permissionBytes:e};const g=[];for(const c of f)g.push(e[c]);return{errMsg:`${b.api}:ok`,permissionBytes:g}}module.exports={login,refreshSession,operateWXData,authorize,openWeRunSetting,chooseInvoiceTitle,addPhoneContact,openAddress,clearAuthorizeQueue(){authorizeQueue=[]},getPermissionBytes};
;}(require("lazyload"), require);
